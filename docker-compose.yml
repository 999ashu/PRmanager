services:
    postgres:
      image: postgres:17
      container_name: service-postgres
      environment:
          - POSTGRES_DB=prmanager_db
          - POSTGRES_USER=admin
          - POSTGRES_PASSWORD=admin
          - PGDATA=/var/lib/postgresql/data/pgdata
      ports:
          - "5432:5432"
      volumes:
          - ./PRmanager/postgresql/schemas:/docker-entrypoint-initdb.d/01-schemas
          - ./PRmanager/postgresql/data:/docker-entrypoint-initdb.d/02-data
          - prmanager_postgres_data:/var/lib/postgresql/data
          - ./PRmanager/postgresql/migrations:/migrations
          - ./PRmanager/scripts/apply_migrations.sh/apply_migrations.sh:/usr/local/bin/apply_migrations.sh:ro
      networks:
          - postgres
      healthcheck:
        test: ["CMD-SHELL", "pg_isready -U admin -d prmanager_db"]
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s

    migrations-runner:
      image: postgres:17
      container_name: service-migrations-runner
      environment:
        - POSTGRES_DB=prmanager_db
        - POSTGRES_USER=admin
        - POSTGRES_PASSWORD=admin
        - POSTGRES_HOST=postgres
        - POSTGRES_PORT=5432
      volumes:
        - ./PRmanager/postgresql/migrations:/migrations:ro
        - ./PRmanager/scripts/apply_migrations.sh/apply_migrations.sh:/usr/local/bin/apply_migrations.sh:ro
      entrypoint: ["bash", "/usr/local/bin/apply_migrations.sh", "/migrations"]
      depends_on:
        postgres:
          condition: service_healthy
      networks:
        - postgres
      restart: "no"

    builder:
        image: ghcr.io/userver-framework/ubuntu-22.04-userver-pg-dev:latest
        platform: linux/amd64
        container_name: service-builder
        environment:
          - PREFIX=${PREFIX:-~/.local}
          - LOCAL_UID=${LOCAL_UID:-1000}
          - LOCAL_GID=${LOCAL_GID:-1000}
          - CC
          - CXX
          - CMAKE_OPTS=-DCMAKE_BUILD_TYPE=Release
          - MAKE_OPTS=-j$(nproc)
        volumes:
          - ./PRmanager:/PRmanager:rw
          - ./build:/PRmanager/build-release:rw
        working_dir: /PRmanager
        command: >
          bash -c "
          /PRmanager/run_as_user.sh ${LOCAL_UID:-1000} ${LOCAL_GID:-1000} make build-release
          "
        restart: "no"

    PRmanager:
        image: ghcr.io/userver-framework/ubuntu-22.04-userver-pg-dev:latest
        platform: linux/amd64
        privileged: true
        environment:
          - POSTGRES_DB=prmanager_db
          - POSTGRES_USER=admin
          - POSTGRES_PASSWORD=admin
          - POSTGRES_HOST=postgres
          - POSTGRES_PORT=5432
          - PREFIX=${PREFIX:-~/.local}
          - LOCAL_UID=${LOCAL_UID:-1000}
          - LOCAL_GID=${LOCAL_GID:-1000}
          - CC
          - CCACHE_DIR=/PRmanager/.ccache
          - CCACHE_HASHDIR
          - CCACHE_NOHASHDIR
          - CCACHE_PREFIX
          - CCACHE_SIZE
          - CMAKE_OPTS
          - CORES_DIR=/cores
          - CXX
          - MAKE_OPTS
          - USERVER_DISABLE_USERFAULTFD=1
          - USERVER_NO_USERFAULTFD=1
          - USERVER_USE_USERFAULTFD=0
          - USERVER_STACK_USAGE_MONITOR=0
        volumes:
          - ./PRmanager:/PRmanager:rw
          - ./PRmanager/tests:/tools:ro
          - ./build:/PRmanager/build-release:rw
          - ${TC_CORES_DIR:-./.cores}:/cores:rw
        ports:
          - 8080:8080
          - 8081:8081  # Metrics port
        working_dir: /PRmanager
        command: >
          bash -c "
          /PRmanager/run_as_user.sh ${LOCAL_UID:-1000} ${LOCAL_GID:-1000} make start-release
          "
        depends_on:
          postgres:
            condition: service_healthy
          migrations-runner:
            condition: service_completed_successfully
          builder:
            condition: service_completed_successfully
        networks:
          - postgres

networks:
    postgres:
        driver: bridge

volumes:
  prmanager_postgres_data:
